version: '3.8'

services:
  tg_analyzer:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: tg_analyzer
    image: tg_analyzer:latest
    entrypoint: ["python", "-m", "src.cli.daemon"]
    environment:
      # GigaChat API
      - GIGACHAT_AUTH_KEY=${GIGACHAT_AUTH_KEY}
      - GIGACHAT_OAUTH_URL=${GIGACHAT_OAUTH_URL:-https://ngw.devices.sberbank.ru:9443/api/v2/oauth}
      - GIGACHAT_BASE_URL=${GIGACHAT_BASE_URL:-https://gigachat.devices.sberbank.ru/api/v1}
      - GIGACHAT_SCOPE=${GIGACHAT_SCOPE:-GIGACHAT_API_PERS}
      - GIGACHAT_MODEL=${GIGACHAT_MODEL:-GigaChat}

      # Paths
      - TG_FETCHER_DATA_PATH=/data
      - OUTPUT_PATH=/output

      # Redis Configuration
      - REDIS_URL=redis://tg-redis:6379
      - REDIS_PASSWORD=${REDIS_PASSWORD:-}

      # Worker ID (for multi-instance scaling)
      - WORKER_ID=analyzer-1

      # Analysis Settings
      - WINDOW_SIZE=${WINDOW_SIZE:-30}

      # Observability (shared infrastructure)
      - LOKI_URL=http://tg-loki:3100
      - PROMETHEUS_PUSHGATEWAY_URL=http://tg-pushgateway:9091

      # Logging
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - ENVIRONMENT=${ENVIRONMENT:-development}
    volumes:
      # Mount data from tg_fetcher (read-only)
      - ../python-tg/data:/data:ro
      # Mount output directory
      - ./output:/output
    networks:
      - tg-infrastructure
    restart: unless-stopped
    profiles:
      - daemon

# Use external shared infrastructure network
networks:
  tg-infrastructure:
    external: true
    name: tg-infrastructure
