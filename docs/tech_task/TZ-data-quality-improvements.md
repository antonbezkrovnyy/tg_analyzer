# TZ: Улучшение качества и количества анализируемых дискуссий

## Статус
- [ ] В ожидании
- [ ] В работе
- [ ] Реализовано

## Бизнес-цель
На основе анализа реальных данных (2025-11-05) выявлено, что из 30 сообщений GigaChat находит 1 дискуссию, что является правильным результатом (реально ценная дискуссия - одна). Однако для достижения цели 3-5 дискуссий на дату необходимо:
1. Увеличить размер анализируемого окна сообщений
2. Настроить пороги качества дискуссий
3. Возможно, добавить категоризацию по ценности

## Результаты анализа данных (2025-11-05)

### Найденные дискуссии в первых 50 сообщениях:

1. **⭐⭐⭐⭐ Gettext и локализация** (ID: 2640504-2640523)
   - Участники: 4-5 человек (°•Serhio'.•`, Alex, Kim Young, Kan)
   - Сообщений: ~20
   - Ценность: Высокая - техническая глубина, конкретная проблема, практические решения
   - Темы: Python i18n, gettext, ngettext, переменные в строках локализации
   - **Вывод**: Правильно найдена GigaChat ✅

2. **⭐⭐ Админка для Telegram-бота** (ID: 2640490-2640499)
   - Участники: 5 человек
   - Сообщений: 6
   - Ценность: Средняя - поверхностное обсуждение, мало контекста
   - Темы: Django, phpMyAdmin, CLI
   - **Вывод**: Правильно отфильтрована GigaChat как недостаточно ценная ✅

3. **⭐ Книги и курсы по Python** (ID: 2640467-2640488)
   - Участники: 4 человека
   - Сообщений: 10+
   - Ценность: Низкая - нетехническая, общие фразы, нет конкретики
   - Темы: Образование, книги, курсы
   - **Вывод**: Правильно отфильтрована GigaChat ✅

### Выводы из анализа:

**GigaChat работает корректно!** Из 30 сообщений нашел 1 действительно ценную дискуссию.

**Проблема**: В чате много "шума" - приветствия, короткие реплики, нетехнические темы.

**Решение**: Для получения 3-5 дискуссий нужно:
- Анализировать **100-200 сообщений** вместо 30
- Или снизить порог качества (включать дискуссии на ⭐⭐)
- Или добавить категории с разными порогами

## Идеи для улучшения

### 1. Увеличение окна анализа
**Текущее состояние**: 30 сообщений → 1 дискуссия
**Предложение**:
- 100 сообщений → ожидается 3-4 дискуссии
- 200 сообщений → ожидается 6-8 дискуссий

**Риски**:
- Увеличение токенов (30 сообщений = ~4000 токенов)
- 100 сообщений ≈ 13000-15000 токенов
- 200 сообщений может превысить лимит контекста

**Решение**:
- Протестировать на разных размерах окна (50, 100, 150)
- Найти оптимальный баланс токены/качество

### 2. Настройка порогов качества
**Варианты**:
- **Строгий режим** (текущий): Только ⭐⭐⭐⭐ дискуссии (техническая глубина + практическая польза)
- **Средний режим**: ⭐⭐⭐ и выше (включить средние технические дискуссии)
- **Мягкий режим**: ⭐⭐ и выше (включить все обсуждения с минимальной технической составляющей)

**Реализация**: Добавить параметр в промпт или настройку

### 3. Категоризация дискуссий
**Категории**:
- **Техническая** (⭐⭐⭐⭐⭐): Глубокое обсуждение архитектуры, паттернов, решений
- **Практическая** (⭐⭐⭐⭐): Конкретные проблемы и решения
- **Образовательная** (⭐⭐⭐): Обучающие вопросы-ответы
- **Обсуждение инструментов** (⭐⭐): Сравнение библиотек, фреймворков
- **Общая** (⭐): Нетехнические темы, карьера, книги

**Польза**: Пользователь может фильтровать по категориям

### 4. Динамическая настройка
**Идея**: Анализатор адаптируется под плотность дискуссий в чате
- Если за 30 сообщений нашел 0 дискуссий → увеличить окно до 50
- Если за 30 сообщений нашел 5+ дискуссий → можно оставить 30
- Автоматически подбирать размер окна для достижения цели 3-5 дискуссий

## Технические задачи (для последующей реализации)

Эти задачи будут реализованы ПОСЛЕ базовой инфраструктуры:

### Задача 1: Экспериментирование с размером окна
**Описание**: Провести эксперименты на разных датах с разными размерами окна
**Метрики**:
- Количество найденных дискуссий
- Токены использованы
- Качество дискуссий (субъективная оценка)

**План**:
1. Тест на 50 сообщениях (3 разных даты)
2. Тест на 100 сообщениях (3 разных даты)
3. Тест на 150 сообщениях (1-2 даты)
4. Анализ результатов, выбор оптимального размера

### Задача 2: Улучшение промпта для получения 3-5 дискуссий
**Текущее поведение**: Промпт просит 3-5, но GigaChat находит 1 (что правильно при 30 сообщениях)

**Варианты улучшения**:
1. **Адаптивный промпт**:
   - Для 30 сообщений: "найди 1-2 дискуссии"
   - Для 100 сообщений: "найди 3-5 дискуссий"
   - Для 200 сообщений: "найди 5-10 дискуссий"

2. **Снизить порог**:
   - Текущий: "только технические темы с глубиной"
   - Новый: "технические темы средней и высокой ценности"

3. **Добавить примеры**:
   - Показать GigaChat примеры дискуссий разного качества
   - "⭐⭐⭐⭐ - это когда..., ⭐⭐ - это когда..."

### Задача 3: Категоризация и оценка качества
**Описание**: Добавить в модель `Discussion` поля:
```python
class Discussion(BaseModel):
    topic: str
    keywords: list[str]
    participants: list[str]
    summary: str
    expert_comment: str
    message_links: list[str]

    # NEW:
    category: Literal["technical", "practical", "educational", "tools", "general"]
    quality_rating: Literal[1, 2, 3, 4, 5]  # Звезды
    confidence: float  # 0.0-1.0, насколько GigaChat уверен в оценке
```

**Промпт изменения**: Попросить GigaChat оценить категорию и качество

### Задача 4: Настройка фильтров
**Конфигурация** (config/analysis_config.yaml):
```yaml
analysis:
  window_size: 100  # Количество сообщений для анализа
  min_discussions: 3
  max_discussions: 5
  quality_threshold: 2  # Минимум ⭐⭐

  filters:
    min_messages_per_discussion: 2
    min_participants: 2
    exclude_categories: ["general"]  # Исключить нетехнические

  categories_enabled: true
  adaptive_window: true  # Автоматически подбирать размер окна
```

### Задача 5: Валидация message_links
**Описание**: Проверять, что все ссылки корректные

**Проверки**:
1. Формат: `https://t.me/{chat_username}/{message_id}`
2. `{chat_username}` совпадает с ожидаемым
3. `{message_id}` существует в исходных данных
4. Все ID из дискуссии присутствуют в message_links

**Реализация**:
```python
class LinkValidator:
    def validate_discussion_links(
        self,
        discussion: Discussion,
        chat_username: str,
        message_ids: list[int]
    ) -> ValidationResult:
        """Validate all links in discussion."""
        errors = []
        warnings = []

        for link in discussion.message_links:
            # Check format
            if not link.startswith(f"https://t.me/{chat_username}/"):
                errors.append(f"Wrong username in link: {link}")

            # Extract message_id
            msg_id = int(link.split("/")[-1])

            # Check existence
            if msg_id not in message_ids:
                warnings.append(f"Message {msg_id} not in input data")

        return ValidationResult(
            is_valid=len(errors) == 0,
            errors=errors,
            warnings=warnings
        )
```

## Зависимости
Эти улучшения зависят от следующих компонентов (которые будут реализованы РАНЬШЕ):
1. ✅ PromptBuilder service - для динамической генерации промптов
2. ✅ AnalyzerService - для запуска pipeline
3. ✅ AnalysisRepository - для сохранения результатов
4. ✅ Конфигурация - для настройки параметров

## Приоритет
**Низкий** - эти улучшения будут реализованы ПОСЛЕ базовой инфраструктуры

## Ожидаемые результаты
После реализации:
- Стабильное получение 3-5 дискуссий на дату (при наличии достаточного количества сообщений)
- Возможность настройки качества и категорий
- Валидация корректности ссылок
- Адаптация под разные чаты (плотные/разреженные)

## Метрики успеха
1. **Покрытие**: 80%+ дат содержат 3-5 дискуссий
2. **Точность**: 90%+ найденных дискуссий оцениваются как ценные вручную
3. **Recall**: Не пропускаем важные дискуссии (субъективная оценка на выборке)
4. **Валидность ссылок**: 100% ссылок корректные
